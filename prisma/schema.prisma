generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum SfdaStatus {
  approved
  pending
  not_submitted
}

enum ProductStatus {
  active
  in_development
  discontinued
}

model Category {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?  @db.Text
  createdAt   DateTime @default(now()) @map("created_at")

  products            Product[]
  pricingTiers        PricingTier[]
  companyPricingTiers CompanyPricingTier[]

  @@map("categories")
}

model Product {
  id              String        @id @default(uuid())
  name            String
  categoryId      String?       @map("category_id")
  skuPrefix       String        @map("sku_prefix")
  description     String?       @db.Text
  keyIngredients  String?       @map("key_ingredients") @db.Text
  caffeineFree    Boolean       @default(true) @map("caffeine_free")
  sfdaStatus      SfdaStatus    @default(not_submitted) @map("sfda_status")
  sfdaReference   String?       @map("sfda_reference")
  baseCost        Decimal       @map("base_cost") @db.Decimal(10, 2)
  baseRetailPrice Decimal       @map("base_retail_price") @db.Decimal(10, 2)
  size            Decimal?      @db.Decimal(10, 2)
  unit            String?       @default("gm")
  image           String?
  status          ProductStatus @default(active)
  launchDate      DateTime?     @map("launch_date")
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  category          Category?         @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  pricingTiers      PricingTier[]
  productionBatches ProductionBatch[]
  orderItems        OrderItem[]
  finishedProduct   FinishedProduct?

  @@map("products")
}

model PricingTier {
  id              String   @id @default(uuid())
  productId       String?  @map("product_id")
  tierName        String   @map("tier_name")
  minOrderKg      Decimal  @map("min_order_kg") @db.Decimal(10, 2)
  maxOrderKg      Decimal  @default(0) @map("max_order_kg") @db.Decimal(10, 2)
  pricePerKg      Decimal  @map("price_per_kg") @db.Decimal(10, 2)
  discountPercent Decimal  @map("discount_percent") @db.Decimal(5, 2)
  marginPercent   Decimal  @map("margin_percent") @db.Decimal(5, 2)
  isGlobal        Boolean  @default(false) @map("is_global")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  categoryId          String?              @map("category_id")
  product             Product?             @relation(fields: [productId], references: [id], onDelete: Cascade)
  category            Category?            @relation(fields: [categoryId], references: [id])
  companies           Company[] // Deprecated direct link. Kept for legacy compatibility if needed.
  companyPricingTiers CompanyPricingTier[] // New category-specific link

  @@map("pricing_tiers")
}

model Supplier {
  id            String   @id @default(uuid())
  name          String
  contactPerson String?  @map("contact_person")
  email         String?
  phone         String?
  address       String?  @db.Text
  notes         String?  @db.Text
  isActive      Boolean  @default(true) @map("is_active")
  createdAt     DateTime @default(now()) @map("created_at")

  rawMaterials RawMaterial[]

  @@map("suppliers")
}

enum BatchStatus {
  planned
  in_progress
  quality_check
  completed
  failed
}

model ProductionBatch {
  id           String      @id @default(uuid())
  batchNumber  String      @unique @map("batch_number")
  productId    String      @map("product_id")
  targetQty    Decimal     @map("target_qty") @db.Decimal(10, 2)
  actualQty    Decimal?    @map("actual_qty") @db.Decimal(10, 2)
  yieldPercent Decimal?    @map("yield_percent") @db.Decimal(10, 2)
  status       BatchStatus @default(planned)
  startDate    DateTime    @map("start_date")
  endDate      DateTime?   @map("end_date")
  qualityScore Int?        @map("quality_score")
  producedBy   String?     @map("produced_by")
  notes        String?     @db.Text
  createdAt    DateTime    @default(now()) @map("created_at")
  updatedAt    DateTime    @updatedAt @map("updated_at")

  product       Product        @relation(fields: [productId], references: [id], onDelete: Cascade)
  batchItems    BatchItem[]
  qualityChecks QualityCheck[]

  @@map("production_batches")
}

model BatchItem {
  id            String   @id @default(uuid())
  batchId       String   @map("batch_id")
  rawMaterialId String?  @map("raw_material_id")
  materialName  String   @map("material_name")
  quantityUsed  Decimal  @map("quantity_used") @db.Decimal(10, 3)
  createdAt     DateTime @default(now()) @map("created_at")

  batch ProductionBatch @relation(fields: [batchId], references: [id], onDelete: Cascade)

  @@map("batch_items")
}

model QualityCheck {
  id                 String   @id @default(uuid())
  batchId            String   @map("batch_id")
  visualInspection   String   @map("visual_inspection")
  visualNotes        String?  @map("visual_notes") @db.Text
  weightVerification String   @map("weight_verification")
  weightNotes        String?  @map("weight_notes") @db.Text
  tasteTest          String   @map("taste_test")
  tasteNotes         String?  @map("taste_notes") @db.Text
  labAnalysis        String?  @map("lab_analysis") @db.Text
  sfdaCompliance     String   @map("sfda_compliance")
  overallScore       Int      @map("overall_score")
  passed             Boolean  @default(false)
  checkedAt          DateTime @map("checked_at")
  notes              String?  @db.Text
  createdAt          DateTime @default(now()) @map("created_at")

  batch ProductionBatch @relation(fields: [batchId], references: [id], onDelete: Cascade)

  @@map("quality_checks")
}

enum RndStatus {
  ideation
  formulation
  testing
  sfda_submission
  approved
  archived
}

model RndProject {
  id                 String    @id @default(uuid())
  name               String
  category           String
  status             RndStatus @default(ideation)
  leadId             String?   @map("lead_id")
  formulationDetails String?   @map("formulation_details") @db.Text
  testResults        String?   @map("test_results") @db.Text
  costEstimate       Decimal?  @map("cost_estimate") @db.Decimal(10, 2)
  targetLaunchDate   DateTime? @map("target_launch_date")
  relatedSuppliers   Json?     @map("related_suppliers")
  attachments        Json?
  notes              String?   @db.Text
  createdAt          DateTime  @default(now()) @map("created_at")
  updatedAt          DateTime  @updatedAt @map("updated_at")

  @@map("rnd_projects")
}

model SystemSettings {
  id                   String   @id @default(cuid())
  productionCapacityKg Float    @default(3000)
  updatedAt            DateTime @updatedAt

  @@map("system_settings")
}

// ==========================================
// Phase 3: CRM (Clients, Companies, Deals)
// ==========================================

enum ClientType {
  client
  lead
  supplier
  partner
  investor
  other
}

enum LeadSource {
  website
  event
  referral
  cold_outreach
  social_media
  manual_import
}

model Company {
  id            String   @id @default(uuid())
  name          String
  industry      String?
  city          String?
  website       String?
  lifetimeValue Decimal  @default(0) @map("lifetime_value") @db.Decimal(10, 2)
  pricingTierId String?  @map("pricing_tier_id") // Deprecated
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations
  pricingTier         PricingTier?         @relation(fields: [pricingTierId], references: [id], onDelete: SetNull) // Deprecated
  contacts            Client[] // The employees/contacts that work at this company
  deals               Deal[] // Sales pipeline deals linked to this company
  companyPricingTiers CompanyPricingTier[] // The specific pricing tiers this company has per product category
  orders              Order[] // Orders placed by this B2B company

  @@map("companies")
}

// Phase 3.2.1: Multi-Category Pricing Tiers
model CompanyPricingTier {
  id            String   @id @default(uuid())
  companyId     String   @map("company_id")
  categoryId    String   @map("category_id")
  pricingTierId String   @map("pricing_tier_id")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations
  company     Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  category    Category    @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  pricingTier PricingTier @relation(fields: [pricingTierId], references: [id], onDelete: Cascade)

  // Enforce one tier per category for each company
  @@unique([companyId, categoryId])
  @@map("company_pricing_tiers")
}

// Note: In Safcha's dashboard, "Clients" represent individual Contacts/People
model Client {
  id            String     @id @default(uuid())
  name          String
  email         String?
  phone         String?
  companyId     String?    @map("company_id")
  role          String?
  type          ClientType @default(lead)
  source        LeadSource @default(manual_import)
  tags          Json? // JSON array of strings for custom tags (e.g. ["Cafe Owner", "VIP"])
  city          String?
  lastContacted DateTime?  @map("last_contacted")
  notes         String?    @db.Text
  assignedTo    String?    @map("assigned_to") // User ID (String for now)
  createdAt     DateTime   @default(now()) @map("created_at")
  updatedAt     DateTime   @updatedAt @map("updated_at")

  // Relations
  company Company? @relation(fields: [companyId], references: [id], onDelete: SetNull)
  deals   Deal[] // Sales pipeline deals directly linked to this contact
  orders  Order[] // Orders placed by this specific client

  @@map("clients")
}

enum DealStage {
  new_lead
  qualified
  sample_sent
  proposal
  negotiation
  closed_won
  closed_lost
}

model Deal {
  id                String    @id @default(uuid())
  title             String // e.g. "Wholesale Supply - Half Million Cafe"
  value             Decimal   @default(0) @db.Decimal(10, 2)
  stage             DealStage @default(new_lead)
  expectedCloseDate DateTime? @map("expected_close_date")
  priority          String    @default("medium")
  companyId         String?   @map("company_id")
  clientId          String?   @map("client_id")
  assignedTo        String?   @map("assigned_to") // User ID managing this deal
  notes             String?   @db.Text
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  // Relations
  company Company? @relation(fields: [companyId], references: [id], onDelete: SetNull)
  client  Client?  @relation(fields: [clientId], references: [id], onDelete: SetNull)

  @@map("deals")
}

// ==========================================
// Phase 4: Sales & Orders
// ==========================================

enum OrderChannel {
  b2b
  b2c
  pos
  event
  export
  other
}

enum OrderStatus {
  draft
  confirmed
  processing
  shipped
  delivered
  cancelled
}

enum PaymentStatus {
  pending
  paid
  partially_paid
  overdue
}

enum FulfillmentStatus {
  unfulfilled
  partially_fulfilled
  fulfilled
}

model Order {
  id                String            @id @default(uuid())
  orderNumber       String            @unique @map("order_number") // e.g., ORD-2026-0001
  date              DateTime          @default(now())
  channel           OrderChannel      @default(b2b)
  status            OrderStatus       @default(draft)
  paymentStatus     PaymentStatus     @default(pending) @map("payment_status")
  fulfillmentStatus FulfillmentStatus @default(unfulfilled) @map("fulfillment_status")
  subTotal          Decimal           @default(0) @map("sub_total") @db.Decimal(10, 2)
  discount          Decimal           @default(0) @db.Decimal(10, 2)
  vat               Decimal           @default(0) @db.Decimal(10, 2)
  shippingCost      Decimal           @default(0) @map("shipping_cost") @db.Decimal(10, 2)
  grandTotal        Decimal           @default(0) @map("grand_total") @db.Decimal(10, 2)
  notes             String?           @db.Text

  clientId  String  @map("client_id")
  companyId String? @map("company_id")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  client     Client      @relation(fields: [clientId], references: [id], onDelete: Restrict)
  company    Company?    @relation(fields: [companyId], references: [id], onDelete: SetNull)
  orderItems OrderItem[]
  invoice    Invoice?

  @@map("orders")
}

model OrderItem {
  id        String   @id @default(uuid())
  orderId   String   @map("order_id")
  productId String   @map("product_id")
  quantity  Int      @default(1)
  unitPrice Decimal  @map("unit_price") @db.Decimal(10, 2)
  discount  Decimal  @default(0) @db.Decimal(10, 2)
  total     Decimal  @default(0) @db.Decimal(10, 2)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Restrict)

  @@map("order_items")
}

enum InvoiceStatus {
  draft
  sent
  paid
  void
}

model Invoice {
  id            String        @id @default(uuid())
  orderId       String        @unique @map("order_id")
  invoiceNumber String        @unique @map("invoice_number") // e.g., INV-2026-0001
  issueDate     DateTime      @default(now()) @map("issue_date")
  dueDate       DateTime      @map("due_date")
  totalAmount   Decimal       @map("total_amount") @db.Decimal(10, 2)
  status        InvoiceStatus @default(draft)
  pdfUrl        String?       @map("pdf_url")
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")

  // Relations
  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@map("invoices")
}

// ==========================================
// Phase 5: Inventory
// ==========================================

enum StockMovementType {
  STOCK_IN
  STOCK_OUT
  ADJUSTMENT
  TRANSFER
  RETURN
}

enum StockMovementReason {
  PURCHASE
  PRODUCTION_INPUT
  ORDER_FULFILLMENT
  DAMAGE
  SAMPLE
  EVENT
}

enum MaterialCategory {
  BASE_POWDER
  FLAVORING
  PACKAGING
  OTHER
}

enum InventoryLocation {
  AL_AHSA_WAREHOUSE
  KHOBAR_OFFICE
}

model RawMaterial {
  id               String            @id @default(uuid())
  name             String
  sku              String            @unique
  category         MaterialCategory
  currentStock     Decimal           @default(0) @map("current_stock") @db.Decimal(10, 3) // Need 3 decimal places for kg precision
  unitCost         Decimal           @map("unit_cost") @db.Decimal(10, 2)
  reorderThreshold Decimal?          @map("reorder_threshold") @db.Decimal(10, 3)
  reorderQuantity  Decimal?          @map("reorder_quantity") @db.Decimal(10, 3)
  location         InventoryLocation
  lastRestocked    DateTime?         @map("last_restocked")
  expiryDate       DateTime?         @map("expiry_date")
  createdAt        DateTime          @default(now()) @map("created_at")
  updatedAt        DateTime          @updatedAt @map("updated_at")

  // Supplier relation (proper FK)
  supplierId String?   @map("supplier_id")
  supplier   Supplier? @relation(fields: [supplierId], references: [id], onDelete: SetNull)

  stockMovements StockMovement[]

  @@map("raw_materials")
}

model FinishedProduct {
  id               String            @id @default(uuid())
  productId        String            @unique @map("product_id")
  variant          String
  sku              String            @unique
  currentStock     Decimal           @default(0) @map("current_stock") @db.Decimal(10, 2)
  reservedStock    Decimal           @default(0) @map("reserved_stock") @db.Decimal(10, 2)
  unitCost         Decimal           @map("unit_cost") @db.Decimal(10, 2)
  retailPrice      Decimal           @map("retail_price") @db.Decimal(10, 2)
  reorderThreshold Decimal?          @map("reorder_threshold") @db.Decimal(10, 2)
  location         InventoryLocation
  expiryDate       DateTime?         @map("expiry_date")
  batchNumber      String?           @map("batch_number")
  createdAt        DateTime          @default(now()) @map("created_at")
  updatedAt        DateTime          @updatedAt @map("updated_at")

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  stockMovements StockMovement[]

  @@map("finished_products")
}

model StockMovement {
  id                String              @id @default(uuid())
  movementId        String              @unique @map("movement_id") // e.g., SM-2026-0001
  date              DateTime            @default(now())
  type              StockMovementType
  quantity          Decimal             @db.Decimal(10, 3) // allow negative or positive, up to 3 decimal places
  reason            StockMovementReason
  notes             String?             @db.Text
  referenceId       String?             @map("reference_id") // stores OrderId, BatchId, etc.
  performedById     String?             @map("performed_by_id")
  rawMaterialId     String?             @map("raw_material_id")
  finishedProductId String?             @map("finished_product_id")
  createdAt         DateTime            @default(now()) @map("created_at")
  updatedAt         DateTime            @updatedAt @map("updated_at")

  // Relations
  rawMaterial     RawMaterial?     @relation(fields: [rawMaterialId], references: [id], onDelete: Restrict)
  finishedProduct FinishedProduct? @relation(fields: [finishedProductId], references: [id], onDelete: Restrict)

  @@index([rawMaterialId])
  @@index([finishedProductId])
  @@map("stock_movements")
}

// ==========================================
// Phase 8: Finance
// ==========================================

enum TransactionType {
  revenue
  expense
}

enum ExpenseCategory {
  raw_materials
  production
  shipping
  marketing
  salaries
  rent
  utilities
  equipment
  other
}

enum PaymentMethod {
  bank_transfer
  cash
  credit_card
}

model Transaction {
  id            String          @id @default(uuid())
  transactionId String          @unique @map("transaction_id") // e.g., TXN-2026-0001
  type          TransactionType
  amount        Decimal         @db.Decimal(10, 2)
  description   String
  date          DateTime        @default(now())
  referenceId   String?         @map("reference_id") // OrderNumber for revenue, Expense ID for expenses
  orderId       String?         @map("order_id")
  createdAt     DateTime        @default(now()) @map("created_at")
  updatedAt     DateTime        @updatedAt @map("updated_at")

  @@map("transactions")
}

model Expense {
  id            String          @id @default(uuid())
  expenseId     String          @unique @map("expense_id") // e.g., EXP-2026-0001
  category      ExpenseCategory
  amount        Decimal         @db.Decimal(10, 2)
  vat           Decimal         @default(0) @db.Decimal(10, 2)
  description   String
  vendor        String?
  paymentMethod PaymentMethod?  @map("payment_method")
  date          DateTime        @default(now())
  receiptUrl    String?         @map("receipt_url")
  notes         String?         @db.Text
  createdAt     DateTime        @default(now()) @map("created_at")
  updatedAt     DateTime        @updatedAt @map("updated_at")

  @@map("expenses")
}
