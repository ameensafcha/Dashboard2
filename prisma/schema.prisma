generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum SfdaStatus {
  approved
  pending
  not_submitted
}

enum ProductStatus {
  active
  in_development
  discontinued
}

model Category {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?  @db.Text
  createdAt   DateTime @default(now()) @map("created_at")

  products            Product[]
  pricingTiers        PricingTier[]
  companyPricingTiers CompanyPricingTier[]

  @@map("categories")
}

model Product {
  id              String        @id @default(uuid())
  name            String
  categoryId      String?       @map("category_id")
  skuPrefix       String        @map("sku_prefix")
  description     String?       @db.Text
  keyIngredients  String?       @map("key_ingredients") @db.Text
  caffeineFree    Boolean       @default(true) @map("caffeine_free")
  sfdaStatus      SfdaStatus    @default(not_submitted) @map("sfda_status")
  sfdaReference   String?       @map("sfda_reference")
  baseCost        Decimal       @map("base_cost") @db.Decimal(10, 2)
  baseRetailPrice Decimal       @map("base_retail_price") @db.Decimal(10, 2)
  size            Decimal?      @db.Decimal(10, 2)
  unit            String?       @default("gm")
  image           String?
  status          ProductStatus @default(active)
  launchDate      DateTime?     @map("launch_date")
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  category          Category?         @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  pricingTiers      PricingTier[]
  productionBatches ProductionBatch[]

  @@map("products")
}

model PricingTier {
  id              String   @id @default(uuid())
  productId       String?  @map("product_id")
  tierName        String   @map("tier_name")
  minOrderKg      Decimal  @map("min_order_kg") @db.Decimal(10, 2)
  maxOrderKg      Decimal  @default(0) @map("max_order_kg") @db.Decimal(10, 2)
  pricePerKg      Decimal  @map("price_per_kg") @db.Decimal(10, 2)
  discountPercent Decimal  @map("discount_percent") @db.Decimal(5, 2)
  marginPercent   Decimal  @map("margin_percent") @db.Decimal(5, 2)
  isGlobal        Boolean  @default(false) @map("is_global")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  categoryId          String?              @map("category_id")
  product             Product?             @relation(fields: [productId], references: [id], onDelete: Cascade)
  category            Category?            @relation(fields: [categoryId], references: [id])
  companies           Company[] // Deprecated direct link. Kept for legacy compatibility if needed.
  companyPricingTiers CompanyPricingTier[] // New category-specific link

  @@map("pricing_tiers")
}

model Supplier {
  id            String   @id @default(uuid())
  name          String
  contactPerson String?  @map("contact_person")
  email         String?
  phone         String?
  address       String?  @db.Text
  notes         String?  @db.Text
  isActive      Boolean  @default(true) @map("is_active")
  createdAt     DateTime @default(now()) @map("created_at")

  @@map("suppliers")
}

enum BatchStatus {
  planned
  in_progress
  quality_check
  completed
  failed
}

model ProductionBatch {
  id           String      @id @default(uuid())
  batchNumber  String      @unique @map("batch_number")
  productId    String      @map("product_id")
  targetQty    Decimal     @map("target_qty") @db.Decimal(10, 2)
  actualQty    Decimal?    @map("actual_qty") @db.Decimal(10, 2)
  yieldPercent Decimal?    @map("yield_percent") @db.Decimal(10, 2)
  status       BatchStatus @default(planned)
  startDate    DateTime    @map("start_date")
  endDate      DateTime?   @map("end_date")
  qualityScore Int?        @map("quality_score")
  producedBy   String?     @map("produced_by")
  notes        String?     @db.Text
  createdAt    DateTime    @default(now()) @map("created_at")
  updatedAt    DateTime    @updatedAt @map("updated_at")

  product       Product        @relation(fields: [productId], references: [id], onDelete: Cascade)
  batchItems    BatchItem[]
  qualityChecks QualityCheck[]

  @@map("production_batches")
}

model BatchItem {
  id            String   @id @default(uuid())
  batchId       String   @map("batch_id")
  rawMaterialId String?  @map("raw_material_id")
  materialName  String   @map("material_name")
  quantityUsed  Decimal  @map("quantity_used") @db.Decimal(10, 3)
  createdAt     DateTime @default(now()) @map("created_at")

  batch ProductionBatch @relation(fields: [batchId], references: [id], onDelete: Cascade)

  @@map("batch_items")
}

model QualityCheck {
  id                 String   @id @default(uuid())
  batchId            String   @map("batch_id")
  visualInspection   String   @map("visual_inspection")
  visualNotes        String?  @map("visual_notes") @db.Text
  weightVerification String   @map("weight_verification")
  weightNotes        String?  @map("weight_notes") @db.Text
  tasteTest          String   @map("taste_test")
  tasteNotes         String?  @map("taste_notes") @db.Text
  labAnalysis        String?  @map("lab_analysis") @db.Text
  sfdaCompliance     String   @map("sfda_compliance")
  overallScore       Int      @map("overall_score")
  passed             Boolean  @default(false)
  checkedAt          DateTime @map("checked_at")
  notes              String?  @db.Text
  createdAt          DateTime @default(now()) @map("created_at")

  batch ProductionBatch @relation(fields: [batchId], references: [id], onDelete: Cascade)

  @@map("quality_checks")
}

enum RndStatus {
  ideation
  formulation
  testing
  sfda_submission
  approved
  archived
}

model RndProject {
  id                 String    @id @default(uuid())
  name               String
  category           String
  status             RndStatus @default(ideation)
  leadId             String?   @map("lead_id")
  formulationDetails String?   @map("formulation_details") @db.Text
  testResults        String?   @map("test_results") @db.Text
  costEstimate       Decimal?  @map("cost_estimate") @db.Decimal(10, 2)
  targetLaunchDate   DateTime? @map("target_launch_date")
  relatedSuppliers   Json?     @map("related_suppliers")
  attachments        Json?
  notes              String?   @db.Text
  createdAt          DateTime  @default(now()) @map("created_at")
  updatedAt          DateTime  @updatedAt @map("updated_at")

  @@map("rnd_projects")
}

model SystemSettings {
  id                   String   @id @default(cuid())
  productionCapacityKg Float    @default(3000)
  updatedAt            DateTime @updatedAt

  @@map("system_settings")
}

// ==========================================
// Phase 3: CRM (Clients, Companies, Deals)
// ==========================================

enum ClientType {
  client
  lead
  supplier
  partner
  investor
  other
}

enum LeadSource {
  website
  event
  referral
  cold_outreach
  social_media
  manual_import
}

model Company {
  id            String   @id @default(uuid())
  name          String
  industry      String?
  city          String?
  website       String?
  lifetimeValue Decimal  @default(0) @map("lifetime_value") @db.Decimal(10, 2)
  pricingTierId String?  @map("pricing_tier_id") // Deprecated
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations
  pricingTier         PricingTier?         @relation(fields: [pricingTierId], references: [id], onDelete: SetNull) // Deprecated
  contacts            Client[] // The employees/contacts that work at this company
  deals               Deal[] // Sales pipeline deals linked to this company
  companyPricingTiers CompanyPricingTier[] // The specific pricing tiers this company has per product category

  @@map("companies")
}

// Phase 3.2.1: Multi-Category Pricing Tiers
model CompanyPricingTier {
  id            String   @id @default(uuid())
  companyId     String   @map("company_id")
  categoryId    String   @map("category_id")
  pricingTierId String   @map("pricing_tier_id")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations
  company     Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  category    Category    @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  pricingTier PricingTier @relation(fields: [pricingTierId], references: [id], onDelete: Cascade)

  // Enforce one tier per category for each company
  @@unique([companyId, categoryId])
  @@map("company_pricing_tiers")
}

// Note: In Safcha's dashboard, "Clients" represent individual Contacts/People
model Client {
  id            String     @id @default(uuid())
  name          String
  email         String?
  phone         String?
  companyId     String?    @map("company_id")
  role          String?
  type          ClientType @default(lead)
  source        LeadSource @default(manual_import)
  tags          Json? // JSON array of strings for custom tags (e.g. ["Cafe Owner", "VIP"])
  city          String?
  lastContacted DateTime?  @map("last_contacted")
  notes         String?    @db.Text
  assignedTo    String?    @map("assigned_to") // User ID (String for now)
  createdAt     DateTime   @default(now()) @map("created_at")
  updatedAt     DateTime   @updatedAt @map("updated_at")

  // Relations
  company Company? @relation(fields: [companyId], references: [id], onDelete: SetNull)
  deals   Deal[] // Sales pipeline deals directly linked to this contact

  @@map("clients")
}

enum DealStage {
  new_lead
  qualified
  sample_sent
  proposal
  negotiation
  closed_won
  closed_lost
}

model Deal {
  id                String    @id @default(uuid())
  title             String // e.g. "Wholesale Supply - Half Million Cafe"
  value             Decimal   @default(0) @db.Decimal(10, 2)
  stage             DealStage @default(new_lead)
  expectedCloseDate DateTime? @map("expected_close_date")
  companyId         String?   @map("company_id")
  clientId          String?   @map("client_id")
  assignedTo        String?   @map("assigned_to") // User ID managing this deal
  notes             String?   @db.Text
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  // Relations
  company Company? @relation(fields: [companyId], references: [id], onDelete: SetNull)
  client  Client?  @relation(fields: [clientId], references: [id], onDelete: SetNull)

  @@map("deals")
}
